{% extends 'base.html' %}

{% load static %}
{% load crispy_forms_tags %}
{% load widget_tweaks %}

{% block titulo %}
{% endblock %}

{% block content %}
<div class="container mt-5 pt-5">
<h3 class="fs-2 fw-semibold">Cadastro</h3>
<hr>
<div>
    <form class="card p-3 mt-5" autocomplete="off" action="{% if form.instance.id %}{% url 'editar-perfil' form.instance.id %}{% else %}{% url 'cadastrar-perfil' %}{% endif %}" method="POST">
        {% csrf_token %}
        <div class="row">
            <div class="col-2">{{ form.codigo|as_crispy_field }}</div>
            <div class="col-8">{{ form.descricao|as_crispy_field }}</div>
            <div class="col-2">{{ form.preco|as_crispy_field }}</div>
        </div>
        <div class="row">
            <div class="col-4" id="idacabamentoperfil" name="acabamento" value="{{acabamento.id}}">{{ form.acabamento|as_crispy_field }}</div>
            <div class="col-4">{{ form.tipo|as_crispy_field }}</div>
            <div class="col-4">{{ form.modelo|as_crispy_field }}</div>
        </div>
        <div class="row p-3">
            <div class="col-4 border">
                <div class="pt-1" type="radio" name="encaixe" id="idpermiteperfilpuxador">{{ form.encaixe|as_crispy_field }}</div>
                <div class="" id="idperfilpuxador" name="perfilpuxador" data-initial-puxador="{{ perfil_puxador_ids }}">
                    <div class="form-check" {% if form.instance.encaixe == '1' %}style="display: block;"{% else %}style="display: none;"{% endif %}>
                        <input type="checkbox" name="perfil_puxador" id="perfil_puxador_{{ perfil_puxador.id }}" value="{{ perfil_puxador.id }}" class="form-check-input" {% if perfil_puxador in form.initial.perfil_puxador.all %}checked>{% endif %}
                        <label for="perfil_puxador_{{ perfil_puxador.id }}" class="form-check-label">{{ perfil_puxador.descricao }}</label>
                    </div>
                </div>
            </div>
            <div class="col-4 border">
                <div class="pt-1" type="radio" name="encaixedivisor" id="idpermitedivisor">{{ form.encaixedivisor|as_crispy_field }}</div>
                <div class="" id="iddivisor" name="divisor" data-initial-divisor="{{ divisor_ids }}">
                    <div class="" id="iddivisor" name="divdivisor" {% if form.instance.encaixedivisor == '1' %}style="display: block;"{% else %}style="display: none;"{% endif %}>
                        <input type="checkbox" name="divisor" id="divisor_{{ divisor.id }}" value="{{ divisor.id }}" class="form-check-input" {% if divisor in form.initial.divisor.all %}checked>{% endif %}
                        <label for="divisor_{{ divisor.id }}" class="form-check-label">{{ divisor.descricao }}</label>
                    </div>
                </div>
            </div>
            <div class="col-4 border">
                <div class="pt-1" type="radio" name="encaixepuxador" id="idpermitepuxador">{{ form.encaixepuxador|as_crispy_field }}</div>
                <div class="" id="idpuxador" name="puxador" data-initial-puxador="{{ puxador_ids }}">
                    <div class="" id="idpuxador" name="puxadorsobreposto" {% if form.instance.encaixepuxador == '1' %}style="display: block;"{% else %}style="display: none;"{% endif %}>
                        <input type="checkbox" name="puxador" id="puxador_{{ puxador.id }}" value="{{ puxador.id }}" class="form-check-input" {% if puxador in form.initial.puxador.all %}checked>{% endif %}
                        <label for="puxador_{{ puxador.id }}" class="form-check-label">{{ puxador.descricao }}</label>
                    </div>
                </div>
            </div>
        </div>
        <div class="d-flex justify-content-end">
            <button type="submit" class="btn btn-outline-primary" style="width: 100px;">
                {% if form.instance.id %}
                    Salvar
                {% else %}
                    Cadastrar
                {% endif %}
            </button>
        </div>
    </form>
</div>

<script>
$(document).ready(function() {
  function filtrarPerfilPuxador() {
    var acabamento = $('#id_acabamento').val();
    var resultadosPerfilPuxador = $('#idperfilpuxador');
    resultadosPerfilPuxador.empty();
    var perfilPuxadorIds = resultadosPerfilPuxador.data('initial-puxador');

    if ($('input[name="encaixe"]:checked').val() === '1') {
      $.ajax({
        url: '{% url 'filtrar_acabamento' %}',
        type: 'GET',
        data: {
          acabamento: acabamento
        },
        success: function(response) {
          $.each(response, function(index, item) {
            var checkboxId = 'checkbox_perfil_puxador_' + item.id;
            var checkboxLabel = $('<label>').attr('for', checkboxId).addClass('form-check-label').text(item.descricao);
            var checkboxInput = $('<input>').attr('type', 'checkbox').attr('name', 'perfil_puxador').attr('id', checkboxId).attr('value', item.id).addClass('form-check-input');

            var checkboxDiv = $('<div>').addClass('form-check').append(checkboxInput, checkboxLabel);
            var option = $('<div>').append(checkboxDiv);

            if (perfilPuxadorIds && perfilPuxadorIds.includes(item.id.toString())) {
              checkboxInput.prop('checked', true);
            }

            resultadosPerfilPuxador.append(option);
          });
        },
        error: function(xhr) {
          console.log(xhr.statusText);
        }
      });

    } else {
      resultadosPerfilPuxador.hide();
    }
  }

  function filtrarDivisor() {
    var acabamento = $('#id_acabamento').val();
    var resultadosDivisor = $('#iddivisor');
    resultadosDivisor.empty();
    var divisorIds = resultadosDivisor.data('initial-divisor');

    if ($('input[name="encaixedivisor"]:checked').val() === '1') {
      $.ajax({
        url: '{% url 'filtrar_divisor' %}',
        type: 'GET',
        data: {
          acabamento: acabamento
        },
        success: function(response) {
          $.each(response, function(index, item) {
            var checkboxId = 'checkbox_divisor_' + item.id;
            var checkboxLabel = $('<label>').attr('for', checkboxId).addClass('form-check-label').text(item.descricao);
            var checkboxInput = $('<input>').attr('type', 'checkbox').attr('name', 'divisor').attr('id', checkboxId).attr('value', item.id).addClass('form-check-input');

            var checkboxDiv = $('<div>').addClass('form-check').append(checkboxInput, checkboxLabel);
            var option = $('<div>').append(checkboxDiv);

            if (divisorIds && divisorIds.includes(item.id.toString())) {
              checkboxInput.prop('checked', true);
            }

            resultadosDivisor.append(option);
          });
        },
        error: function(xhr) {
          console.log(xhr.statusText);
        }
      });

    } else {
      resultadosDivisor.hide();
    }
  }

  function filtrarPuxador() {
    var acabamento = $('#id_acabamento').val();
    var resultadosPuxador = $('#idpuxador');
    resultadosPuxador.empty();
    var puxadorIds = resultadosPuxador.data('initial-puxador');

    if ($('input[name="encaixepuxador"]:checked').val() === '1') {
      $.ajax({
        url: '{% url 'filtrar_puxador' %}',
        type: 'GET',
        data: {
          acabamento: acabamento
        },
        success: function(response) {
          $.each(response, function(index, item) {
            var checkboxId = 'checkbox_puxador_' + item.id;
            var checkboxLabel = $('<label>').attr('for', checkboxId).addClass('form-check-label').text(item.descricao);
            var checkboxInput = $('<input>').attr('type', 'checkbox').attr('name', 'puxador').attr('id', checkboxId).attr('value', item.id).addClass('form-check-input');

            var checkboxDiv = $('<div>').addClass('form-check').append(checkboxInput, checkboxLabel);
            var option = $('<div>').append(checkboxDiv);

            if (puxadorIds && puxadorIds.includes(item.id.toString())) {
              checkboxInput.prop('checked', true);
            }

            resultadosPuxador.append(option);
          });
        },
        error: function(xhr) {
          console.log(xhr.statusText);
        }
      });

    } else {
      resultadosPuxador.hide();
    }
  }

  function filtrarResultados() {
    filtrarPerfilPuxador();
    filtrarDivisor();
    filtrarPuxador();
  }

  $('#id_acabamento, input[name="encaixe"], input[name="encaixedivisor"], input[name="encaixepuxador"]').on('change', function() {
    filtrarResultados();
  });

  // Chamar a função filtrarResultados inicialmente
  filtrarResultados();
});
</script>

<script>
  $(document).ready(function() {
    $('input[name="encaixe"]').on('change', function() {
      var valorSelecionado1 = $('input[name="encaixe"]:checked').val();

      // Controlar a primeira div
      if (valorSelecionado1 === '1') {
        $('#idperfilpuxador').show();
      } else {
        $('#idperfilpuxador').hide();
      }
    });
  });

  $(document).ready(function() {
    $('input[name="encaixedivisor"]').on('change', function() {
      var valorSelecionado2 = $('input[name="encaixedivisor"]:checked').val();

      // Controlar a segunda div
      if (valorSelecionado2 === '1') {
        $('#iddivisor').show();
      } else {
        $('#iddivisor').hide();
      }
    });
  });

  $(document).ready(function() {
    $('input[name="encaixepuxador"]').on('change', function() {
      var valorSelecionado3 = $('input[name="encaixepuxador"]:checked').val();

      // Controlar a terceira div
      if (valorSelecionado3 === '1') {
        $('#idpuxador').show();
      } else {
        $('#idpuxador').hide();
      }
    });
  });
</script>


{% endblock %}

